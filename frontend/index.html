<script>
    /* ==========================================
       JAVASCRIPT CORE LOGIC
       ==========================================
    */
    
    const API_URL = "https://mahashetiapp-api.onrender.com";
    const WEATHER_KEY = "895284adae258f1984abac8d7212002f";
    
    let activeChart = null;
    let mainLedgerBalance = 0;
    let savedMarketData = [];

    // --- Welcome Logic ---
    function showWelcome() {
        document.getElementById('welcomeBox').style.display = 'block';
        document.getElementById('mainOverlay').style.display = 'block';
        setTimeout(function() {
        closeWelcome();
    }, 3000); 
}
    function closeWelcome() {
        document.getElementById('welcomeBox').style.display = 'none';
        document.getElementById('mainOverlay').style.display = 'none';
    }

    // Navigation Logic
    function toggleMenu() {
        const menu = document.getElementById('sideNav');
        const overlay = document.getElementById('mainOverlay');
        menu.classList.toggle('open');
        overlay.style.display = menu.classList.contains('open') ? 'block' : 'none';
    }

    function goHome() {
        document.getElementById('home-dashboard').style.display = 'block';
        document.querySelectorAll('.section-box').forEach(s => s.style.display = 'none');
        document.getElementById('back-btn').style.display = 'none'; // Back Button ‡§≤‡§™‡§µ‡§æ
        updateNavIcons('home');
    }

    function openSection(id) {
        document.getElementById('home-dashboard').style.display = 'none';
        document.querySelectorAll('.section-box').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.getElementById('back-btn').style.display = 'block'; // Back Button ‡§¶‡§æ‡§ñ‡§µ‡§æ
        window.scrollTo(0,0);
        updateNavIcons(id);
    }

    function updateNavIcons(id) {
        document.querySelectorAll('.nav-icon-link').forEach(l => l.classList.remove('active'));
        if(id === 'home') document.querySelectorAll('.nav-icon-link')[0].classList.add('active');
        if(id === 'market-sec') document.querySelectorAll('.nav-icon-link')[1].classList.add('active');
        if(id === 'diary-sec') document.querySelectorAll('.nav-icon-link')[2].classList.add('active');
    }

    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }

    // MARKET LOGIC (PARBHANI SPECIAL ENGINE)
    async function loadLiveMarket() {
        const dist = document.getElementById('district-picker').value;
        const loader = document.getElementById('market-load');
        const display = document.getElementById('market-table-box');
        
        loader.style.display = 'block';
        display.innerHTML = "";

        try {
            const response = await fetch(`${API_URL}/api/live-rates?district=${dist}`);
            savedMarketData = await response.json();
            
            if(savedMarketData.length === 0) {
                display.innerHTML = "<p style='text-align:center;'>‡§Ü‡§ú‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</p>";
            } else {
                let tableHtml = `<table class="report-table"><tr><th>‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§∏‡§Æ‡§ø‡§§‡•Ä</th><th>‡§™‡•Ä‡§ï</th><th>‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä ‡§¶‡§∞</th></tr>`;
                const parbhaniFocus = savedMarketData.filter(item => {
                    const c = item.commodity.toLowerCase();
                    return c.includes('soyabean') || c.includes('cotton') || c.includes('gram') || c.includes('turmeric') || c.includes('halad') || c.includes('kapas');
                });
                const others = savedMarketData.filter(item => !parbhaniFocus.includes(item));
                parbhaniFocus.forEach(i => {
                    tableHtml += `<tr class="crop-row-highlight"><td><b>${i.market}</b></td><td>‚≠ê ${i.commodity}</td><td><b>‚Çπ${i.modal_price}</b></td></tr>`;
                });
                others.forEach(i => {
                    tableHtml += `<tr><td>${i.market}</td><td>${i.commodity}</td><td>‚Çπ${i.modal_price}</td></tr>`;
                });
                display.innerHTML = tableHtml + `</table>`;
                document.getElementById('chart-panel').style.display = 'block';
                document.getElementById('btnWA').style.display = 'block';
                renderMarketChart(savedMarketData.slice(0, 5));
            }
        } catch (e) {
            display.innerHTML = "<p style='color:red;'>‡§è‡§∞‡§∞! ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡§™‡§æ‡§∏‡§æ.</p>";
        } finally {
            loader.style.display = 'none';
        }
    }

    function renderMarketChart(data) {
        const ctx = document.getElementById('mktChart').getContext('2d');
        if(activeChart) activeChart.destroy();
        activeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.market),
                datasets: [{ label: '‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§≠‡§æ‡§µ', data: data.map(d => d.modal_price), backgroundColor: '#4caf50', borderRadius: 10 }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    function shareToWA() {
        let text = `üå± *‡§Æ‡§π‡§æ‡§∂‡•á‡§§‡•Ä ‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§≠‡§æ‡§µ ‡§Ö‡§™‡§°‡•á‡§ü - ‡§™‡§∞‡§≠‡§£‡•Ä* \n\n`;
        savedMarketData.slice(0, 5).forEach(i => {
            text += `üìç ${i.market}: *‚Çπ${i.modal_price}* (${i.commodity})\n`;
        });
        text += `\n‡•≤‡§™ ‡§°‡§æ‡§ä‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ: [GitHub Link Here]`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
    }

    // DIARY LOGIC
    function saveToLedger() {
        const name = document.getElementById('itemName').value;
        const val = parseFloat(document.getElementById('itemPrice').value);
        const type = document.getElementById('itemType').value;
        if(!name || isNaN(val)) return alert("‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§Ö‡§ö‡•Ç‡§ï ‡§≠‡§∞‡§æ!");
        mainLedgerBalance += (type === 'income' ? val : -val);
        document.getElementById('netBalance').innerText = `‚Çπ ${mainLedgerBalance}`;
        document.getElementById('netBalance').style.color = mainLedgerBalance >= 0 ? '#1b5e20' : '#d32f2f';
        const history = document.getElementById('ledger-history');
        const entry = document.createElement('div');
        entry.style.display = "flex"; entry.style.justifyContent = "space-between"; entry.style.padding = "15px 0"; entry.style.borderBottom = "1px solid #eee";
        entry.innerHTML = `<span>${name}</span><b style="color:${type==='income'?'green':'red'}">${type==='income'?'+':'-'} ‚Çπ${val}</b>`;
        history.prepend(entry);
        document.getElementById('itemName').value = ""; document.getElementById('itemPrice').value = "";
    }

    // WEATHER ENGINE
    async function getAgriWeather() {
        const city = document.getElementById('cityInput').value;
        if(!city) return alert("‡§∂‡§π‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ!");
        try {
            const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${WEATHER_KEY}&units=metric&lang=mr`);
            const data = await res.json();
            const card = document.getElementById('w-card');
            card.style.display = 'block';
            document.getElementById('w-city').innerText = data.name;
            document.getElementById('w-temp').innerText = Math.round(data.main.temp) + "¬∞C";
            document.getElementById('w-desc').innerText = data.weather[0].description;
        } catch (e) { alert("‡§∂‡§π‡§∞ ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä!"); }
    }

    // TRACTOR LOGIC
    function solveTractor() {
        const area = document.getElementById('tr-area').value;
        const rate = document.getElementById('tr-rate').value;
        const fuel = document.getElementById('tr-fuel').value;
        const totalProfit = (area * rate) - fuel;
        const box = document.getElementById('tr-res');
        box.style.display = 'block';
        box.innerHTML = `‡§è‡§ï‡•Ç‡§£ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§®: <b>‚Çπ${area * rate}</b> <br> ‡§®‡§ø‡§µ‡•ç‡§µ‡§≥ ‡§®‡§´‡§æ: <b style="color:green; font-size:20px;">‚Çπ${totalProfit}</b>`;
    }

    // EMI LOGIC
    function solveEMI() {
        const p = document.getElementById('ln-amt').value;
        const r = (document.getElementById('ln-int').value / 12) / 100;
        const n = document.getElementById('ln-dur').value;
        const emi = (p * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
        const box = document.getElementById('ln-res');
        box.style.display = 'block';
        box.innerHTML = `‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§π‡§™‡•ç‡§§‡§æ: <h2 style="color:var(--bank-blue); margin:5px;">‚Çπ ${Math.round(emi)}</h2> ‡§è‡§ï‡•Ç‡§£ ‡§™‡§∞‡§§‡§´‡•á‡§°: ‚Çπ${Math.round(emi * n)}`;
    }

    // SCANNER LOGIC
    function openAgriScanner() {
        let scanner = new Html5Qrcode("qr-cam");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            const out = document.getElementById('qr-output');
            out.style.display = 'block';
            out.innerHTML = `‡§∏‡•ç‡§ï‡•Ö‡§® ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä! <a href="${decodedText}" target="_blank">‡§Ø‡•á‡§•‡•á ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ</a>`;
            scanner.stop();
        }).catch(err => alert("‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§è‡§∞‡§∞!"));
    }
// ‡•ß. ‡§°‡•â‡§ï‡•ç‡§Ø‡•Å‡§Æ‡•á‡§Ç‡§ü ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§£‡•á
function saveDocument() {
    const name = document.getElementById('docName').value;
    const fileInput = document.getElementById('docFile');
    if (!name || fileInput.files.length === 0) return alert("‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§æ!");

    const reader = new FileReader();
    reader.onload = function(e) {
        const doc = { id: Date.now(), name: name, content: e.target.result };
        let docs = JSON.parse(localStorage.getItem('myDocs') || '[]');
        docs.push(doc);
        localStorage.setItem('myDocs', JSON.stringify(docs));
        displayDocuments();
        alert("‡§ï‡§æ‡§ó‡§¶‡§™‡§§‡•ç‡§∞ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á!");
    };
    reader.readAsDataURL(fileInput.files[0]);
}

// ‡•®. ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡•á‡§≤‡•á‡§≤‡•Ä ‡§ï‡§æ‡§ó‡§¶‡§™‡§§‡•ç‡§∞‡•á ‡§¶‡§æ‡§ñ‡§µ‡§£‡•á
function displayDocuments() {
    const list = document.getElementById('document-list');
    const docs = JSON.parse(localStorage.getItem('myDocs') || '[]');
    list.innerHTML = docs.length === 0 ? '<p style="text-align:center;">‡§≤‡•â‡§ï‡§∞ ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•á ‡§Ü‡§π‡•á.</p>' : '';
    docs.forEach(doc => {
        list.innerHTML += `
            <div style="background:white; padding:15px; border-radius:12px; display:flex; justify-content:space-between; margin-bottom:10px; border:1px solid #eee;">
                <span><b>${doc.name}</b></span>
                <div>
                    <i class="fa-solid fa-eye" style="color:green; cursor:pointer; margin-right:15px;" onclick="viewDoc('${doc.id}')"></i>
                    <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" onclick="deleteDoc('${doc.id}')"></i>
                </div>
            </div>`;
    });
}

// ‡•©. ‡§´‡§æ‡§à‡§≤ ‡§™‡§æ‡§π‡§£‡•á ‡§Ü‡§£‡§ø ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§£‡•á
function viewDoc(id) {
    const docs = JSON.parse(localStorage.getItem('myDocs') || '[]');
    const doc = docs.find(d => d.id == id);
    const win = window.open();
    win.document.write(`<iframe src="${doc.content}" frameborder="0" style="width:100%; height:100%;"></iframe>`);
}

function deleteDoc(id) {
    if(confirm("‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á ‡§ï‡§æ?")) {
        let docs = JSON.parse(localStorage.getItem('myDocs') || '[]');
        docs = docs.filter(d => d.id != id);
        localStorage.setItem('myDocs', JSON.stringify(docs));
        displayDocuments();
    }
}


// ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§§‡§æ‡§ö ‡§´‡§æ‡§à‡§≤‡•ç‡§∏ ‡§¶‡§ø‡§∏‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§π‡•Ä ‡§ì‡§≥ ‡§Ü‡§ß‡•Ä‡§ö‡•ç‡§Ø‡§æ window.onload ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ü‡§æ‡§ï‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§Ö‡§∂‡•Ä‡§ö ‡§†‡•á‡§µ‡§æ
window.addEventListener('load', displayDocuments);
</script>
<script>
      document.addEventListener('deviceready', () => {
        const PushNotifications = Capacitor.Plugins.PushNotifications;

        const setupPush = async () => {
          try {
            let permStatus = await PushNotifications.checkPermissions();

            if (permStatus.receive === 'prompt') {
              permStatus = await PushNotifications.requestPermissions();
            }

            if (permStatus.receive === 'granted') {
              await PushNotifications.register();
              console.log("MahaSheti Push: Registered!");
            }
          } catch (error) {
            console.error("Push Error: ", error);
          }
        };

        setupPush();
      }, false);

    </script>
    <script>
  // ‡§π‡§æ ‡§ï‡•ã‡§° Capacitor ‡§≤‡§æ ‡§∏‡§æ‡§Ç‡§ó‡§§‡•ã ‡§ï‡•Ä ‡§¨‡•Ö‡§ï ‡§¨‡§ü‡§£ ‡§¶‡§æ‡§¨‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§ï‡§æ‡§Ø ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á
  document.addEventListener('DOMContentLoaded', () => {
    const { App } = Capacitor.Plugins;
    
    if (App) {
      App.addListener('backButton', (data) => {
        // ‡§ú‡§∞ ‡§Ø‡•Å‡§ú‡§∞ ‡§π‡•ã‡§Æ ‡§™‡•á‡§ú‡§µ‡§∞ ‡§®‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§Æ‡§æ‡§ó‡•á ‡§®‡•ç‡§Ø‡§æ, ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ ‡•≤‡§™ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§æ
        if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
          App.exitApp();
        } else {
          window.history.back();
        }
      });
    }
  });
</script>
